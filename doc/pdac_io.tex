\section{Input and Output Files}
\label{section:files}

This section describes all the files that are red or written by \PDAC.
Release \PDACVERSION\ does not have a post-processing tool integrated,
so that all interaction you have with the program is through textual files.
The I/O files are always red and written in the running directory,
i.e. the directory from which \PDAC\ has been run.
The level of verbosity, controlling the amount of information written
by the program during the execution, can be set before starting a run
(please note that a too high level of verbosity for very long-lasting 
simulations could cause the program to stop for file-system problems).

\subsection{\PDAC\ input file formats}
\label{section:input_files}

\PDAC\ has two possible input files from which it gets simulation parameters
and the initial conditions. 

A textual parameters file \FIL{pdac.dat} should be compiled by the user
as descirbed below.  \PDAC\ will stop if this file is not present in the 
directory where the executable is running.
It contains the namelists and cards with the parameters of the simulation
and the various option controlling the program execution.

The other Input file that can be required by the program is the restart
file \FIL{pdac.res}. 
\PDAC\ will stop if the restart mode is selected but this file is not present 
in the directory where the executable is running.
This is a binary file written by the code itself and
contains the dump of all independent fields that are saved when a
simulation run is interrupted for any reason. Therefore it cannot be edited by 
the user. Depending on the size of the problem envisaged, the restart file can 
be very large, so that you must ensure that your file-system can manage it.

In a parallel execution all input files are opened, red, and closed
by the root processor (the one with MPI id equal to 0), that
is charged of broadcasting data to the other computing units.

\subsubsection{The \FIL{pdac.dat} file}
\label{section:padc_dat}

This file contains the parameters that define the physical system
you want to simulate with \PDAC. \FIL{pdac.dat} is not red from standard 
input but is connected explicitly to the Fortran unit 5. The file should
be present in the running directory of \PDAC\, and it is always red
at the beginning of the simulation run even if the run is a 
continuation/restart of a previous simulation run. 
The parameters and options in the \FIL{pdac.dat} file are specified
in a set of F90 namelists followed by cards for topography, 
initial and boundary conditions.
The options and values specified determine the exact behavior of
\PDAC, what features are active or inactive, how long the simulation
should last, etc.  
Sect. \ref{section:input_par} lists the parameters required to run a 
simulation, their default values and the range of variability.
Several sample \PDAC\ parameter files are shown in Sect. 
\ref{section:input_sample}.\\

The layout of \FIL{pdac.dat} file is as follows:

\begin{verbatim}
&namelist1
  control_parameters1 = control_value1,
  control_parameters2 = control_value2,
  ...
/

&namelist2
  control_parameters1 = control_value1,
  control_parameters2 = control_value2,
  ...
/
  ...

'CARD1'
card1_parameters

'CARD2'
card2_parameters

  ...

\end{verbatim}

Within a namelist, the parameters are specified as
\begin{verbatim}
keyword      =     value
\end{verbatim}
Blank lines in the namelists are ignored.  Comments are prefaced by
a {\tt !} and may appear after the keyword assignment:
\begin{verbatim}
keyword  = value          !  This is a comment
\end{verbatim}
or may be at the beginning of a line:
\begin{verbatim}
! keyword  = value   This is a keyword commented out
\end{verbatim}
Some keywords require several values, that are specified as an array of values
separated by a comma:
\begin{verbatim}
keyword  = value_1, value_2, value_3,
\end{verbatim}

Note that the namelists and the cards should appear in exactly the order
specified (see Sect. \ref{section:input_par}). 
Parameters lines in the namelists are optional, if a parameter is omitted
it will take a default values (see Sect. \ref{section:input_par}).
On the contrary parameter lines in the cards are not optional and
should always be present.
Comments are allowed in the namelist using the "!" character to identify 
that what follows is a comment. Comment are not allowed within the cards
parameter, but you could insert free text (not including cards and namelists 
names) between different namelists and cards.
Parameters within cards are in general distributed on more lines depending
on the simulation parameters. The layout of the input parameters 
within each cards is described in details in Sect. \ref{section:input_par}.

\subsubsection{The \FIL{pdac.res} file}
\label{section:pdac_res}

\PDAC\ dumps all fields and parameters that are required to restart a 
simulation from exactly the same instant on the file \FIL{pdac.res}.
The file is in double precision binary format to maintain the numerical 
accuracy of the internal representation of numbers and to save space. 
This file is not meant for post-processing
and analysis of the fields, since its internal layout could
vary easily from one version of the code to the other.
The restart file is connected to the Fortran unit 9, it is
opened in {\it READ} mode at the beginning of a restart simulation run,
to read in the status of a previous simulation interrupted.
Then \FIL{pdac.res} file is opened in {\it WRITE} mode at regular intervals
of simulated time. The rate at which \FIL{pdac.res} is overwritten
with a new dump of the simulation status is specified by
the user through the control parameter "tdump" 
(see Sect. \ref{section:input_par} ).
All the appropriate measures should be taken in order
not to lose this file. We suggest to make a copy of the file in 
a safe device (such as tapes) before every run, since any error occurring
when the file is opened in write mode could make you losing it.

\subsection{\PDAC\ output file formats}
\label{section:output_files}

\PDAC\ writes several output files which can be subdivided into 
information and data files. 
Information files (\FIL{pdac.log}, \FIL{pdac.tst} and
\FIL{pdac.err} ) contain logging, testing and debugging information
meant for the user to control the progress of the simulation.
Data files (\FIL{OUTPUT.nnnn}) contain the values of all the 
independent physical fields saved at regular interval of time, in different 
files distinguished by an incremental index (the ``nnnn'' in the file name).
Obviously the restart file described above can be considered also as an 
output data file.

Data output files are opened,
written and closed by the root processor (the one having MPI rank equal to 0), 
that gathers data from the other computing units before writing.
All other information output files 
are opened, written and closed by all processors, and can be distinguished
by an extension indicating the rank of the processor. 

\subsubsection{The \FIL{pdac.log} file}
\label{section:padc_log}

The file \FIL{pdac.log} is used by \PDAC\ to log information
concerning the progress of the simulation. \FIL{pdac.log} is 
connected explicitly to the Fortran unit 6. 
\FIL{pdac.log} is a free text file with self-explanatory information.
Note that \PDAC\ does not use standard output stream but on many
systems the unit 6 is associated by default to the standard output. Therefore,
on these systems, \FIL{pdac.log} is actually a redirected standard output stream.
It is important also to underline that when a new \FIL{pdac.log} is opened 
\PDAC\ cancels any existing \FIL{pdac.log} file.

\subsubsection{The \FIL{pdac.tst} file}
\label{section:padc_tst}

The file \FIL{pdac.tst}, like \FIL{pdac.log}, is a free text file that contains debugging
and testing informations. This is meant for developers only,
therefore the information present in it is not particularly useful to the common user.
The file is connected to the Fortran unit 7 and is cleared every new run.

\subsubsection{The \FIL{pdac.err} file}
\label{section:padc_err}

Like \FIL{pdac.log} and \FIL{pdac.tst}, \FIL{pdac.err} is a free textual file.
It is connected to the Fortran unit 8. In this file \PDAC\ writes
all messages related to severe errors that cause the program to stop.
Note that this file is not cleared at every run but it is opened in 
{\it APPEND} mode.

\subsubsection{Output file}

All scalar and vector fields related to the evolution of the simulated
system are saved into the \FIL{OUTPUT.nnnn} files at regular intervals of
simulated time. The user can choose the interval of time through
the control parameter \OBJ{tpr} (see Sect. \ref{section:input_par} ).
The extension ``nnnn'' is a progressive number, ranging from 0000 to 9999, 
incremented each time the fields are written. 
The output files are associated to the Fortran unit 12. 
The format of these file can be selected by the user.
The logical control parameter \OBJ{formatted\_output} controls if the
output will be written in formatted textual format
or in binary (single precision) format. In general, the output files 
are meant for post-processing analysis, it is therefore useful to know 
their layout. In both formatted and binary forms, the fields are saved
in this order:

\begin{verbatim}

time            ! Simulated time

p               ! Thermodynamic pressure
ug              ! Gas velocity along x
vg              ! Gas velocity along y (only for 3D simulations)
wg              ! Gas velocity along z
tg              ! Gas temperature

xgc             ! Molar fraction of gas components
...             ! (for all gas components)

eps(s)          ! Volumetric fraction of particle class (s)
us(s)           ! Particle velocity along x
vs(s)           ! Particle velocity along y (only for 3D simulations)
ws(s)           ! Particle velocity along z
ts(s)           ! Particle temperature
...             ! (for all solid phases)

\end{verbatim}

where the first line is a scalar real value representing the 
simulated time at which the fields are written and the other lines
represent the fields (of dimension {\tt nx*ny*nz}) that are written 
using the Fortran format specifier {\tt FORMAT( 5(G14.6E3,1X) )}.
The components of the gas and solid velocities in the y dimension
({\tt vg} and {\tt vs}) are present in the output file only if the simulation
type is 3D.

When the file is written in the binary unformatted format,
time and each variable is written in a separate record.
In particular time is written in a record of lenght 1
while all other fields in records of lenght {\tt nx*ny*nz}.

\subsection{Post-processing files}
\label{sect:pp}

\PDAC\ release \PDACVERSION\ provides the executable \FIL{postp.x} utility,
that is intended to be a pre-processing tool for the visualization of
output files produced by \PDAC. Even though this tool is still under 
development its usage is shortly described in this section in order to make it
useful for the user, especially when the output of very large simulations
are too big to be processed directly by a visualization tool.
\FIL{postp.x} extracts from a series of \FIL{OUTPUT.nnnn} files the individual single fields,
with the possibility of downsize, interpolate, and crop the data
and stores them in separate files that can be easily plotted with
various graphical application. Moreover it can process the flow fields to
compute derived quantities of physical interest. 
Another important feature of the post-processor \FIL{postp.x} is that
together with the output filds it write a XML file containing the
full descripion of the grid and of the output filds files, so that
any analysis or graphic program with an XML importer/reader can
read the code ouputs. XML meta-language is infact presently 
considered as one of the most portable and flexible way of 
exchanging data between applications, and it has the largely
appreciated characteristic of being human readable.

\subsubsection{Post-processing input files}

The pre-processing tool must read the input file \FIL{pdac.dat} and an
input file \FIL{pp.dat}, containing the parameters that control the post-processing.
Some examples of these input files can be found in the \DIR{EXPLORIS/examples} directory
in the repository.

\subsubsection{Post-processing output files}

The post-processing produces several output files
containing all individual fields and grid information useful
for visualization.
In particular, post-processing \FIL{pp.x} reads a sequence
of \FIL{OUTPUT.nnnn} files (the numbers indicating the first, the last, and
the increment of ``nnnn'' are red in input)
and writes out a sequence of files for each individual field.
The name of new files are of the form \FIL{filter.[fieldname].nnnn}.
The format of these file is the same of output, as specified above.
A list of all files produced by the post-processing is the following:

\begin{itemize}

\item \FIL{pdac.xml}  \\
      this file contains a detailed description of the grid, fields 
      and of the other filds files, it is written using an XML compliant format

\item \FIL{filter.pgas.nnnn} \\
      these files contain the gas pressure field 

\item \FIL{filter.ug.nnnn} \\
      these files contain the gas velocity field in x-direction
      for the gas phase

\item \FIL{filter.vg.nnnn} \\
      these files contain the gas velocity field in y-direction
      for the gas phase
      This file is not present in 2D simulations

\item \FIL{filter.wg.nnnn} \\
      these files contain the gas velocity field in z-direction
for the gas phase

\item \FIL{filter.tgas.nnnn} \\
      these files contain the gas temperature field 

\item \FIL{filter.xgGG.nnnn} \\
      these files contain the molar fraction fields for all the gas 
      components (GG runs from 01 to ngas) 

\item \FIL{filter.epSS.nnnn} \\
      these files contain the particle volume fraction fields for all the 
      solid phases (SS runs from 01 to nsolid) 

\item \FIL{filter.tsSS.nnnn} \\
      these files contain the particles temperature fields
      for all solid phases (SS run from 01 to nsolid)

\item \FIL{filter.usSS.nnnn} \\
      these files contain the particles velocity fields in x-direction
      for all solid phases (SS run from 01 to nsolid)

\item \FIL{filter.vsSS.nnnn} \\
      these files contain the particles velocity fields in y-direction
      for all solid phases (SS run from 01 to nsolid)
      These files are not present in 2D simulations

\item \FIL{filter.wsSS.nnnn} \\
      these files contain the particles velocity fields in z-direction
      for all solid phases (SS run from 01 to nsolid)

\end{itemize}

Note that when running the post-processing all 
\FIL{OUTPUT.nnnn} files in the selected range should 
be present in the running directory of \FIL{pp.x}

\subsubsection{XML tags}

all what is required to be able to correctly interpret the XML file
is the meaning of the XML tags used to structure the file itself.
Once a meaning has been associated to each tag, then any code
that can read XML could also import the ouput fields files 
produced by the psot-processor \FIL{pp.x} .
The following XML tags have been defined:

\begin{itemize}

\item \FIL{\tt <dataset></dataset>} \\
      the highest level tag specifying the complete output of a post-processor run,
      all other tags should be contained in this one. Attribute:\\
      {\it name} the name of the dataset (ex. \FIL{<dataset name="Vesuvius">})

\item \FIL{\tt <grid></grid>} \\
      identify the section containing information on the computational grid and
      fields defined on it

\item \FIL{\tt <structure></structure>} \\
      defined in the grid section, identify the section containing grid sizes

\item \FIL{\tt <x></x>} \\
      identify a section containig sub-tags referring to x cartesian axis

\item \FIL{\tt <y></y>} \\
      identify a section containig sub-tags referring to y cartesian axis

\item \FIL{\tt <z></z>} \\
      identify a section containig sub-tags referring to z cartesian axis

\item \FIL{\tt <dim> $N$ </dim>} \\
      specify a dimension. Attributes:\\
      {\it type} the type of the dimension (ex. \FIL{\tt <dim type="integer">})
      {\it size} the size of the dimension (ex. \FIL{\tt <dim size="1">})

\item \FIL{\tt <cfile> filename </cfile>} \\

\item \FIL{\tt <file> filename </file>} \\

\item \FIL{\tt <attributes> </attributes>} \\
      identify a section the attributes of the discretized grid

\item \FIL{\tt <profile> </profile>} \\
      identify a section containig information abount profile

\item \FIL{\tt <scalar> </scalar>} \\
      identify a section containig scalar field data

\item \FIL{\tt <staggered> </staggered>} \\
      identify a section containig staggered vector field data

\item \FIL{\tt <frames> </frames>} \\
      identify a section containig information abount time frame

\item \FIL{\tt <timestep> </timestep>} \\
      specify a time frame
       

\end{itemize}


example of post-processing XML output file:

\begin{verbatim}
<?xml version="1.0" encoding="UTF-8"?>
<dataset name="jet_simulation">
  <grid>
    <structure>
      <x>
        <dim type="integer" size="1">64</dim>
        <cfile type="ascii" linetoskip="2">mesh.dat</cfile>
        <file type="ascii" linetoskip="16">mesh.dat</file>
      </x>
      <z>
        <dim type="integer" size="1">128</dim>
        <cfile type="ascii" linetoskip="34">mesh.dat</cfile>
        <file type="ascii" linetoskip="61">mesh.dat</file>
      </z>
    </structure>
    <attributes>
      <profile name="profile">
        <file type="ascii">improfile.dat</file>
      </profile>
      <scalar name="P">
        <file type="ascii" linetoskip="8">output</file>
      </scalar>
      <staggered name="VG">
        <x>
          <file type="ascii" linetoskip="908">output</file>
        </x>
        <z>
          <file type="ascii" linetoskip="1808">output</file>
        </z>
      </staggered>
      <scalar name="TG">
        <file type="ascii" linetoskip="2708">output</file>
      </scalar>
      <scalar name="XGC1">
        <file type="ascii" linetoskip="3608">output</file>
      </scalar>
      <scalar name="XGC2">
        <file type="ascii" linetoskip="4508">output</file>
      </scalar>
      <scalar name="EPS1">
        <file type="ascii" linetoskip="5408">output </file>
      </scalar>
      <staggered name=" VS1">
        <x>
          <file type="ascii" linetoskip="6308">output</file>
        </x>
        <z>
          <file type="ascii" linetoskip="7208">output</file>
        </z>
      </staggered>
      <scalar name="TS1">
        <file type="ascii" linetoskip="8108">output</file>
      </scalar>
      <scalar name="EPS2">
        <file type="ascii" linetoskip="9008">output</file>
      </scalar>
      <staggered name=" VS2">
        <x>
          <file type="ascii" linetoskip="9908">output</file>
        </x>
        <z>
          <file type="ascii" linetoskip="10808">output</file>
        </z>
      </staggered>
      <scalar name="TS2">
        <file type="ascii" linetoskip="11708">output</file>
      </scalar>
    </attributes>
  </grid>
  <frames timestart=".0000000D+00" timescale=".1000000D-01">
    <timestep type="integer" size="1">1000</timestep>
  </frames>
</dataset>
\end{verbatim}

A dataset consists in a certain number of frames defined over a simulation grid. 
A grid involves a structure (a geometry and therefore coordinates) and attributes: 
scalars, vectors, staggered vectors and a profile of the terrain.
The spatial dimension of the grid depends by the number of specified coordinates. 
In the previous example only x and z appears therefore the grid is assumed 2D.



%\subsection{General remark}
%
%\noindent Caveat:
%
%\noindent 1. ..... MAXIMUM DIMENSION
%
%\noindent 2. ..... DISK SPACE
%
%\noindent 3. ..... AVOIDING DATA LOSS
